<div data-controller="quotes" class="container"> 

  <h1 class="text-center col-12">Cálculo de cotización</h1>

  <%= form_with(model: @quote, url: quotes_path, local: true) do |form| %>
    <% if @quote.errors.any? %>
      <div style="color: red">
        <h2><%= pluralize(@quote.errors.count, "error") %> prohibited this quote from being saved:</h2>
        <ul>
          <% @quote.errors.each do |error| %>
            <li><%= error.full_message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <hr style="border: 1px solid black;">
    <div class="row ml-3">
      <div class="col-6">
        <div class="form-group">
          <%= form.label :pieces, "Nombre del proyecto:", class: "font-weight-bold" %>
          <%= form.text_field :projects_name, step: :any, class: "form-control", value: "Nombre del proyecto" %>
        </div>

        <div class="form-group">
          <%= form.label :customer, "Cliente:", class: "font-weight-bold" %>
          <%= form.text_field :projects_name, step: :any, class: "form-control", value: "Nombre del cliente" %>
        </div>

        <div class="form-group">
          <%= form.label :pieces, "Cantidad de piezas:", class: "font-weight-bold" %>
          <%= form.number_field :pieces, step: :any, class: "form-control", value: 2000 %>
        </div>

        <div class="form-group">
          <%= form.label :width, "Ancho del producto:", class: "font-weight-bold" %>
          <%= form.number_field :width, step: :any, class: "form-control", value: 34 %>
        </div>

        <div class="form-group">
          <%= form.label :length, "Largo del producto:", class: "font-weight-bold" %>
          <%= form.number_field :length, step: :any, class: "form-control", value: 23 %>
        </div>

        <div class="form-group">
          <%= form.label :material_id, "Material principal:", class: "font-weight-bold" %>
          <div class="input-group">
            <div class="input-group-prepend">
              <span class="input-group-text" id="material_price_display">$0.00</span>
              <span class="input-group-text ml-1" id="material_unit_display"></span>
            </div>
            <%= form.select :material_id,
                      options_for_select(
                        Material.all.map { |m|
                        [m.description, m.id, { 'data-width' => m.width, 'data-length' => m.lenght, 'data-price' => m.price, 'data-unit' => m.unit.description }]
                        },
                        selected: @quote.material_id
                      ),
                      { include_blank: 'Select one' },
                      { class: "form-control",
                        'data-action': 'change->quotes#showMaterialPrice' 
            } %>
          </div>
        </div>

        <button data-action="quotes#calculateProducts" class="btn btn-green">
          Calcular Productos
        </button>
      </div>

      <div class="col-6">
        <br><br><br><br><br><br>
        <table class="table table-bordered"> 
          <thead class="thead-light"> 
            <tr>
              <th>Concepto</th>
              <th>Valor</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Productos por pliego:</td>
              <td id="products-fit" style="text-align: right;"></td> 
            </tr>
            <tr>
              <td>Pliegos necesarios:</td>
              <td id="material-pieces" style="text-align: right;"></td> 
            </tr>
            <tr>
              <td>Precio material:</td>
              <td id="material-price" style="text-align: right;"></td> 
            </tr>
            <tr>
              <td>Metros cuadrados de material:</td>
              <td id="square-meters" style="text-align: right;"></td> 
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <hr style="border: 1px solid black;">
    <div class="nested-fields"> 
      <div class="row ml-3">
        <div class="col-6">
          <div class="form-group">
            <%= form.label :manufacturing_process_id, "Procesos:", class: "font-weight-bold" %>
            <div class="input-group"> 
              <div class="input-group-prepend">
                <span class="input-group-text" id="manufacturing_process_price_display">$0.00</span>
                <span class="input-group-text ml-1" id="manufacturing_process_unit_display"></span>
              </div>
              <%= form.select :manufacturing_process_id,
                        options_for_select(
                          ManufacturingProcess.all.map { |mp|
                          ["#{mp.name} - #{mp.description}", mp.id, { 'data-price' => mp.price, 'data-unit' => mp.unit.description }]
                          },
                          selected: @quote.manufacturing_process_id
                        ),
                        { include_blank: 'Select one' },
                        { class: "form-control",
                          'data-action': 'change->quotes#showManufactureProcessInfo' 
              } %>
            </div>
          </div>

          <button data-action="quotes#addProcess" class="btn btn-green">
            Agregar Proceso
          </button> 
        </div>
                              
        <div class="col-6">
        <br>
          <table data-quotes-target="processes" class="table table-bordered"> 
            <thead class="thead-light"> 
              <tr>
                <th>Proceso</th>
                <th>Precio Total</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
        
      </div>
    </div>
    <hr style="border: 1px solid black;">

    <% waste_config = GeneralConfiguration.find_by(description: "Merma") %>
    <% margin_config = GeneralConfiguration.find_by(description: "Margen") %>

    <div class="row ml-3">
      <div class="col-6">
        <div class="form-group">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span><%= form.label :waste_percentage, "Desperdicio:" %></span>
            <div style="display: flex; align-items: center; white-space: nowrap;">
              <span id="waste-percentage"><%= waste_config ? "#{waste_config.amount}%" : "N/A" %></span> 
            </div>
          </div>
        </div>
      </div>
      <div class="col-6"> 
        <div class="form-group">
          <div style="display: flex; justify-content: flex-end; align-items: center;"> 
            <%= form.text_field :waste_value, step: :any, class: "form-control", style: "width: 150px; text-align: right;" %>
          </div>
        </div>
      </div>
    </div>

    <div class="row ml-3">
      <div class="col-6">
        <button data-action="quotes#calculateSubTotal" class="btn btn-green">
          Calcular subtotal
        </button>
        <span><%= form.label :pieces, "Subtotal:", class: "font-weight-bold" %></span>
      </div>
      <div class="col-6">
        <div class="form-group">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; white-space: nowrap;">
              <%= form.text_field :sub_total_value, step: :any, class: "form-control", style: "width: 150px; text-align: right;", id: "sub-total-value" %>
          </div>
          </div>
        </div>
      </div>
    </div>

    <hr style="border: 1px solid black;">

    <div class="row ml-3">
    <div class="col-6">
        <div class="form-group">
          <%= form.label :margin_percentage, "Margen:" %>
          <div id="margin-percentage" style="text-align: right;"><%= margin_config ? "#{margin_config.amount}%" : "N/A" %></div> 
          <%= form.text_field :margin_value, step: :any, class: "form-control" %>
          </div>
      </div>
      <div class="col-6">
        <div class="form-group">
          <%= form.label :final_quote_value, "Precio total de la cotización:" %>
          <div id="final-quote-value" style="text-align: right;"></div> 
        </div>
      </div>
      <div class="col-6">
        <button data-action="quotes#calculateQuote" class="btn btn-green">
          Calcular cotización
        </button> 
      </div>
      
    </div>
    <hr style="border: 1px solid black;">

    <div class="row ml-3">
      <div class="col-6">
        <button data-action="quotes#createQuotePDF" class="btn btn-green">
          Generar cotización en PDF
        </button> 
      </div>
    </div>
    <hr style="border: 1px solid black;">

    <h2 class="ml-3">Herramentales</h2>
    <div id="toolings" data-quotes-target="toolings">
      <ul></ul>
      <%= form.fields_for :quote_toolings do |quote_tooling_form| %>
        <%= render 'quote_tooling_fields', f: quote_tooling_form %>
      <% end %>
    </div>
    <div class="row ml-3">
      <div class="col-4">
        <button data-action="quotes#addTooling" class="btn btn-green">
          Agregar Herramental
        </button>
      </div>
      <div class="col-6">
        </div>
    </div>

    <div class="row ml-3">
      <div class="col-6">
        <%= form.submit "Crear Cotización", class: "btn btn-green" %>
      </div>
      <div class="col-6">
        </div>
    </div>

  <% end %>
</div>